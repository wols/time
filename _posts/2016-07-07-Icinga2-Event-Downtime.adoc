= Icinga2 - Event Downtime
:published_at: 2016-07-07
:hp-tags:      icinga2, icingaweb2, icingaweb2-director, monitoring
:linkattrs:
:toc:          macro
:toc-title:    Inhalt

event_downtime - Event Plugin Command zur Benutzung mit Icinga2

toc::[]

== Anwendungsfälle

link:https://www.icinga.org/[Icinga, window="_blank"] und andere Monitoring-Systeme werden überwiegend zur Überwachung dauerhaft erreichbarer Komponenten eingesetzt.
Es gibt Szenarien in denen die *Nichterreichbarkeit aber durchaus normal* ist, und deshalb keine Alarmierung oder Benachrichtigung erfolgen soll:

* Notebooks
** Ruhe- und Ausschalt-Perioden
** Offline-Perioden beim Ensatz an unterschiedlichen Standorten
* Virtuelle Maschinen (Xen DomU, VirtualBox)
** Entwicklungs- und Test-Maschinen mit temporären Einsatz-Perioden
* Netzwerk-Drucker
** Energiesparperioden außerhalb der Arbeitszeiten

[TIP]
====
Wenn Du `event_downtime` für einen der genannten Fälle brauchen kannst, klicke auf +++<iframe src="https://ghbtns.com/github-btn.html?user=wols&repo=event_downtime&type=star" frameborder="0" scrolling="0" width="52px" height="20px"></iframe>+++ - Danke!
====

== Host-Szenarios

Mit `event_downtime` lässt sich ein link:http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/monitoring-basics#event-command-restart-service-daemon[Event Handler, window="_blank"] `event_downtime-host` für folgendes Szenario realisieren:

. Host `raspi` ist `UP` und wird mit allen seinen Services überwacht.
. Host `raspi` geht `DOWN`.
.. Event Handler `event_downtime-host` wird ausgelöst.
... Kommando `SCHEDULE_HOST_DOWNTIME` wird abgesetzt.footnoteref:[api, Icinga 2 API ab v0.3.0 https://github.com/wols/event_downtime/issues/2[#2, window="_blank"]]
. Host `raspi` geht `UP`.
.. Event Handler `event_downtime-host` wird ausgelöst.
... Kommando `DEL_DOWNTIME_BY_HOST_NAME` wird abgesetzt.footnoteref:[api]
. weiter mit 1.

.Ablauf
ifndef::env-github[]
[ditaa, target="diagram/flow", png]
----
      +------------------------------------------+
      |                                          |
      v 1                                        |
+-----+------+                                   |
| {c}        |                                   |
|            |    3+---------------------------+ |
| HOST_STATE +-UP->| DEL_DOWNTIME_BY_HOST_NAME +-+
|            |     +---------------------------+ |
|            |                                   |
+-----+------+                                   |
      | 2          +---------------------------+ |
      +------DOWN->| SCHEDULE_HOST_DOWNTIME    +-+
                   +---------------------------+
----
endif::[]
ifdef::env-github[]
image::/time/images/2016/07/07/diagram/flow.png[]
endif::[]

----
COMMAND[UP]="DEL_DOWNTIME_BY_HOST_NAME;<host_name>"

COMMAND[DOWN]="SCHEDULE_HOST_DOWNTIME;<host_name>;<start_time>;<end_time>;<fixed>;<trigger_id>;<duration>;<author>;<comment>"
----

Quelle: link:http://docs.icinga.org/icinga2/latest/doc/module/icinga2/chapter/icinga2-features#external-commands[Icinga 2 Features - External Commands, window="_blank"]

== Installation

Download: +++<iframe src="https://ghbtns.com/github-btn.html?user=wols&repo=event_downtime&type=watch&v=2" frameborder="0" scrolling="0" width="64px" height="20px"></iframe>+++

[source, bash]
----
cp event_downtime /path/to/PluginDir/
chmod a+x /path/to/PluginDir/event_downtime
----

== Test

[source, bash]
----
sudo -H -u icinga /usr/lib/nagios/plugins/event_downtime raspi UP HARD 1 604800

sudo -H -u icinga /usr/lib/nagios/plugins/event_downtime raspi DOWN HARD 1 604800
----

[source]
----
# tailf /var/log/icinga2/icinga2.log | grep -E "(DOWNTIME)"

[2016-06-23 22:20:37 +0000] information/ExternalCommandListener: Executing external command: [1466684437] DEL_DOWNTIME_BY_HOST_NAME;raspi

[2016-06-23 22:22:27 +0000] information/ExternalCommandListener: Executing external command: [1466684547] SCHEDULE_HOST_DOWNTIME;raspi;1466684547;1467289347;1;0;604800;event_downtime-host;'DOWN HARD 1'
----

== Konfiguration

=== Icingaweb 2 Module Director

==== Datenliste 'list-downtime_duration'

Zuerst lege ich eine Datenliste mit den Zeitperioden an, in denen ich Hosts mindestens einmal aktiv `UP` sehen möchte.

image::/time/images/2016/07/07/01-icinga_director.png[title="Icinga Director - Add list | Add data list entry"]

===== Datenlisteneinträge

----
   60 x 60 =     3600 = hour
 hour x 24 =    86400 = day
  day x  7 =   604800 = week
 week x  4 =  2419200 = month
month x 12 = 29030400 = year
----

Diese Auswahl ermöglicht mir die verschiedensten Host-Typen zuzuordnen:

* `hour` - Hosts, die nicht länger als eine Stunde offline sein sollen
* `day` - Hosts, die tägliche Aktualisierungen erhalten müssen
* `week` - Hosts, im Home-Office, die mindestens einmal wöchentlich am Unternehmensnetz sein müssen
* `month` - Hosts, deren Backup nicht zu sehr veralten darf
* `year` - Hosts, die nie vergessen werden sollen :-)

image::/time/images/2016/07/07/02-icinga_director.png[title="Icinga Director - Data lists | List entries"]

==== Datenfeld 'downtime_duration'

Das Datenfeld `downtime_duration` wird später mit einem Wert aus `list-downtime_duration` gefüllt.

image::/time/images/2016/07/07/03-icinga_director.png[title="Icinga Director - Add field"]

image::/time/images/2016/07/07/04-icinga_director.png[title="Icinga Director - Data fields"]

==== Event Command 'event_downtime'

image::/time/images/2016/07/07/05-icinga_director.png[title="Icinga Director - Add new Icinga Command"]

image::/time/images/2016/07/07/06-icinga_director.png[title="Icinga Director - Config preview"]

image::/time/images/2016/07/07/07-icinga_director.png[title="Icinga Director - Icinga Commands"]

==== TODO

image::/time/images/2016/07/07/08-icinga_director.png[title="Icinga Director - Template tree | host-active"]

image::/time/images/2016/07/07/09-icinga_director.png[title="Icinga Director - Template tree | Custom fields: host-active"]

image::/time/images/2016/07/07/10-icinga_director.png[title="Icinga Director - Template tree | Custom fields: host-active"]

==== TODO

image::/time/images/2016/07/07/11-icinga_director.png[title="Icinga Director - Icinga Hosts | raspi"]

image::/time/images/2016/07/07/12-icinga_director.png[title="Icinga Director - Icinga Hosts | raspi"]

image::/time/images/2016/07/07/13-icinga_director.png[title="Icinga Director - Icinga Hosts | Config preview: raspi"]

==== TODO

image::/time/images/2016/07/07/14-icinga_overview.png[title="Overview - Host 'raspi'"]

image::/time/images/2016/07/07/15-icinga_overview.png[title="Overview - Tactical Overview | Hosts 'raspi'"]

==== Wird fortgesetzt...

== Links

* link:https://monitoring-portal.org/index.php?thread/33218-temporär-am-netz-befindlichen-host-mit-nachgelagerten-checks-überwachen/[Monitoring-Portal: temporär am Netz befindlichen Host mit nachgelagerten checks überwachen, window="_blank"]

== Dank

* link:https://github.com/mdo/github-buttons[GitHub Buttons, window="_blank"]

[appendix]
== event_downtime-host.conf

[source]
----
# event_downtime-host.conf

object EventCommand "event_downtime-host" {
    import "event-generic"

    command = [
        PluginDir + "/event_downtime",
        "$host.name$",
        "$host.state$",
        "$host.state_type$",
        "$host.check_attempt$",
        "$host.vars.downtime_duration$"
    ]
}

apply Dependency "downtime-host" to Host {
    host.event_command = "event_downtime-host"

    assign where host.vars.downtime_duration
}
----

// Don't remove next (last) lines!

++++
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.wols.github.io/time"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wolsorg.pro-ssl.de/analytics/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 2]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//wolsorg.pro-ssl.de/analytics/piwik.php?idsite=2" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->
++++
